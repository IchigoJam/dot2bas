
<!DOCTYPE html><html lang="ja"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width"><link rel="icon" href="data:">
<title>multidots</title>
<script defer src="util.js"></script><script defer src="help2.js"></script>
<script>"use strict";
var canvas;
var field;
var bkx, bky;
window.onload = function() {
	var w = 8;
	var box = $('box');
	for (var i = 0; i < w * w; i++) {
		var div = create('div');
		div.onmousedown = function(e) {
			var div = e.srcElement;
			div.style.background = div.style.background == 'black' ? 'white' : 'black';
			sendMessage();
		}
		box.appendChild(div);
	}
	ws.open();
};
var divToString = function() {
	var s = '';
	var divs = $('box').childNodes;
	for (var i = 0; i < divs.length; i++) {
		s += divs[i].style.background == 'black' ? '1' : '0';
	}
	s = bin2hex(s);
	return s;
};
var stringToDiv = function(s) {
	if (s == null)
		return;
	s = hex2bin(s);
	var divs = $('box').childNodes;
	for (var i = 0; i < divs.length && i < s.length; i++) {
		divs[i].style.background = s.charAt(i) == '1' ? 'black' : 'white';
	}
};
var bin2hex = function(s) {
	var res = '';
	for (var i = 0; i < s.length; i += 4) {
		var n = 0;
		for (var j = 0; j < 4; j++) {
			n += s.charAt(i + 3 - j) == '1' ? (1 << j) : 0;
		}
		res += '0123456789abcdef'.charAt(n);
	}
	return res;
};
var hex2bin = function(s) {
	var res = '';
	for (var i = 0; i < s.length; i++) {
		var n = '0123456789abcdef'.indexOf(s.charAt(i));
		if (n < 0)
			n = 0;
		for (var j = 0; j < 4; j++) {
			res += (n & (1 << (3 - j))) != 0 ? '1' : '0';
		}
	}
	return res;
};
// -- connection
var Connection = function(url) {
	this.url = url;
};
Connection.prototype = {
	send: function(data) {
		this.open(data);
	},
	open: function(data) {
		if (this.ws != null) {
			if (data != null)
				this.ws.send(data);
		} else {
			var ws = new WebSocket(this.url);
			var con = this;
			ws.onopen = function() {
				if (con.onopen != null)
					con.onopen();
				if (data != null)
					ws.send(data);
			};
			ws.onclose = function() {
				if (con.onclose != null)
					con.onclose();
				con.ws = null;
			};
			ws.onmessage = function(e) {
				if (con.onmessage != null)
					con.onmessage(e);
			};
			ws.onerror = function(e) {
				if (con.onerror != null)
					con.onerror(e);
			};
			this.ws = ws;
		}
	},
};

var ws = new Connection("ws://fukuno.jig.jp:8090/multidots");
//var ws = new Connection("ws://localhost:8090/multidots");

ws.onopen = function(event) {
	console.log("websocket open");
	stateChange("opened")
};
ws.onmessage = function(event) {
	stringToDiv(event.data);
};
ws.onclose = function(event) {
	console.log("websocket close");
	stateChange("closed");
};
ws.onerror = function(event) {
//	alert("error");
	console.log("error");
	stateChange("error")
};
function sendMessage() {
	ws.send(divToString());
}
function stateChange(state) {
	$("state").innerHTML = state;
}
</script>
<style>
a:link {
	color: #77f;
	text-decoration: none;
}
a:visited {
	color: #33a;
	text-decoration: none;
}
a:hover {
	color: #33a;
	text-decoration: underline;
}
a:active {
	color: #33a;
	text-decoration: underline;
}
body {
	margin: 0px;
	text-align: center;
}
#box {
	margin: 100px auto 30px auto;
	width: 256px;
	height: 256px;
	line-height: 0px;
	border: 4px solid black;
}
#box div {
	display: inline-block;
	width: 30px;
	height: 30px;
	border: 1px solid black;
	background: white;
	margin: 0px;
	padding: 0px;
}
button {
	text-align: center;
	border: 3px solid black;
	background: white;
}
</style>
<body>

<div id='box'></div>
<div id="state"></div>

<div id='credit'><img id='help'><a href='http://fukuno.jig.jp/2012/'>(c)taisukef CED</a></div><div id='helptips'><div id='helptipscontent'>
みんなでドット絵<br>
<br>
ドット絵ツール<a href=monodots>monodots</a>を、WebSocketを使ってみんなで共有してみました。<br>
</div></div>

</body>
<html>

